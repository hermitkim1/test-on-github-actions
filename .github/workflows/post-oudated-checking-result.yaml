name: Post outdated checkering result

on:
  workflow_run:
    workflows: ["Outdated checker"]
    types:
      - completed           
      
jobs:
  post-result:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    permissions:
      issues: write 
#       pull-requests: write      

    env:
      ARTIFACT_DIR: ./dev-ko-outdated-checking-result/ # It will be updated.

    steps:    
    - name: Show the github context
      shell: bash
      run: |
        echo "(DEBUG) ParsedBranch: ${GITHUB_REF#refs/heads/}"
        echo "(DEBUG) github: ${{ github }}"
        echo "(DEBUG) toJSON(github):" 
        echo '${{ toJSON(github) }}'
        echo "(DEBUG) github.action: ${{ github.action }}"
        echo "(DEBUG) github.action_path: ${{ github.action_path }}"
        echo "(DEBUG) github.actor: ${{ github.actor }}"
        echo "(DEBUG) github.base_ref: ${{ github.base_ref	}}"
        echo "(DEBUG) github.event: ${{ github.event }}"
        echo "(DEBUG) github.event_name: ${{ github.event_name }}"
        echo "(DEBUG) github.event_path: ${{ github.event_path }}"
        echo "(DEBUG) github.head_ref: ${{ github.head_ref }}"
        echo "(DEBUG) github.job: ${{ github.job }}"
        echo "(DEBUG) github.ref: ${{ github.ref }}"
        echo "(DEBUG) github.repository: ${{ github.repository }}"
        echo "(DEBUG) github.repository_owner: ${{ github.repository_owner }}"
        echo "(DEBUG) github.run_id: ${{ github.run_id }}"
        echo "(DEBUG) github.run_number: ${{ github.run_number }}"
        echo "(DEBUG) github.sha: ${{ github.sha }}"
        echo "(DEBUG) github.token: ${{ github.token }}"
        echo "(DEBUG) github.workflow: ${{ github.workflow }}"
        echo "(DEBUG) github.workspace: ${{ github.workspace }}"

#     NOTE - "actions/download-artifact" is not working for sharing data between workflows. 
#     - name: Download result
#       uses: actions/download-artifact@v3
    - name: Download result
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: outdated-checker.yaml
        workflow_conclusion: success
        
    - name: Display structure of downloaded files
      run: tree
        
    - name: Generate a result markdown
      shell: bash
      run: |
        FILE_LIST=$(find ${ARTIFACT_DIR} -name '*.md')
        
        # Create checking_result.md
        touch output.md
        
        # Generate markdown
        echo "### Outdated files" >> output.md
        
        for FILE in ${FILE_LIST}; do 
          FILE_NAME="${FILE#${ARTIFACT_DIR}}" 
          echo "- ${FILE_NAME}" >> output.md
        done 
        
        echo "" >> output.md
        
        echo "### More details" >> output.md
        
        for FILE in ${FILE_LIST}; do 
          FILE_NAME="${FILE#${ARTIFACT_DIR}}" 
        
          echo "File: ${FILE_NAME}" >> output.md
          echo "" >> output.md
          echo "\`\`\`diff" >> output.md 
          cat ${FILE} >> output.md      
          echo "\`\`\`" >> output.md 
          
        done 
        
        echo "The end of report"  >> output.md              
        
    - name: Create an issue from file    
      uses: peter-evans/create-issue-from-file@v4
      with:
        title: "[ko] A report to track update"
        content-filepath: output.md
        labels: |
          outdated
          good first issue
          lang/ko
